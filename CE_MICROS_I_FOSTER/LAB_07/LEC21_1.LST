G:\MICROS_1\LAB_07\lec21_1.lst - generated by MGTEK Assembler ASM12 V1.26 Build 144 for WIN32 (x86) - Tue Dec 02 22:12:42 2008

    1:                                 ;************************************************************
    2:                                 ; Names:        Prof. Foster
    3:                                 ; Last Modified:09-1-2008
    4:                                 ; Purpose:      Implement a timer that displays elapsed time
    5:                                 ;               as a 4-digit number of seconds
    6:                                 ;
    7:                                 ; Inputs:       Switch SW5 - PTH pin 0
    8:                                 ;
    9:                                 ; Outputs:      7-segment diplay - PortB all pins
   10:                                 ;               digit enable       PTP pins 3-0
   11:                                 ;       
   12:                                 ; Dependencies: 7segment.s19 is used as a driver for 7-segs
   13:                                 ;
   14:                                 ;************************************************************
   15:                                 
   16:                                 ;*** Constants section
   17:          =00002800              INIT7SEG        EQU     $2800
   18:          =00002880              DIGIT           EQU     $2880
   19:                                 
   20:                                 ; constants for DIGIT subroutine
   21:          =00000001              DIG1            EQU     %00000001 ; left digit
   22:          =00000002              DIG2            EQU     %00000010 ; 2nd from left
   23:          =00000004              DIG3            EQU     %00000100 ; 2nd from right
   24:          =00000008              DIG4            EQU     %00001000 ; right digit
   25:                                 
   26:          =00000001              PORTB           EQU     $0001
   27:          =00000003              DDRB            EQU     $0003
   28:                                 
   29:          =00000260              PTH             EQU     $0260
   30:          =00000262              DDRH            EQU     $0262
   31:          =00000266              PIEH            EQU     $0266
   32:          =00000267              PIFH            EQU     $0267
   33:                                 
   34:          =00000258              PTP             EQU     $0258
   35:          =0000025A              DDRP            EQU     $025A
   36:                                 
   37:          =00000037              CRGFLG          EQU     $0037
   38:          =00000080              RTIF            EQU     %10000000
   39:          =00000038              CRGINT          EQU     $0038
   40:          =00000080              RTIE            EQU     %10000000
   41:          =0000003B              RTICTL          EQU     $003B
   42:                                 
   43:          =00000001              SW5             EQU     %00000001
   44:                                 
   45:          =000003D0              ONESEC          EQU     122*8
   46:                                 
   47:                                                 ; define the interrupt vectors
   48:          =00003E70                              ORG     $3E70
   49:     3E70 2066                                   DC.W    RTIISR
   50:                                 
   51:          =00003E4C                              ORG     $3E4C
   52:     3E4C 20B0                                   DC.W    PTHISR
   53:                                 
   54:          =00001000                              ORG     $1000
   55:                                                 ; create storage for the patterns for
   56:                                                 ; each digit
   57:     1000 +0001                  DIGIT1          DS.B    1
   58:     1001 +0001                  DIGIT2          DS.B    1
   59:     1002 +0001                  DIGIT3          DS.B    1
   60:     1003 +0001                  DIGIT4          DS.B    1
   61:     1004 +0001                  RTICOUNT        DS.B    1       ; tracks number of interrupts
   62:                                 
   63:          =00002000                              ORG     $2000
   64:     2000 CF 3600                                LDS     #$3600
   65:     2003 16 2800                                JSR     INIT7SEG
   66:                                                 ; configure/enable SW5 interrupt (portH)
   67:     2006 1D 0260 01                             BCLR    PTH,SW5
   68:     200A 1C 0266 01                             BSET    PIEH,SW5
   69:                                                 ; configure RTI device          
   70:                                                 ; NOTE: RTI interrupt is enabled/disabled
   71:                                                 ; by PTHISR
   72:     200E 180B 40 003B                           MOVB    #$40,RTICTL     
   73:                                                 
   74:                                                 ; initialize the display to 0's
   75:     2013 180B 30 1000                           MOVB    #$30,DIGIT1
   76:     2018 180B 30 1001                           MOVB    #$30,DIGIT2
   77:     201D 180B 30 1002                           MOVB    #$30,DIGIT3
   78:     2022 180B 30 1003                           MOVB    #$30,DIGIT4
   79:                                                 ; unmask interrupts...
   80:     2027 10EF                                   CLI             
   81:                                                 ; and wait for things to happen
   82:     2029 F6 1000                Loop            LDAB    DIGIT1
   83:     202C 86 01                                  LDAA    #DIG1
   84:     202E 16 2880                                JSR     DIGIT
   85:     2031 16 205F                                JSR     pause
   86:                                 
   87:     2034 F6 1001                                LDAB    DIGIT2
   88:     2037 86 02                                  LDAA    #DIG2
   89:     2039 16 2880                                JSR     DIGIT
   90:     203C 16 205F                                JSR     pause
   91:                                 
   92:     203F F6 1002                                LDAB    DIGIT3
   93:     2042 86 04                                  LDAA    #DIG3
   94:     2044 16 2880                                JSR     DIGIT
   95:     2047 16 205F                                JSR     pause
   96:                                 
   97:     204A F6 1003                                LDAB    DIGIT4
   98:     204D 86 08                                  LDAA    #DIG4
   99:     204F 16 2880                                JSR     DIGIT
  100:     2052 16 205F                                JSR     pause
  101:     2055 20 D2                                  BRA     Loop
  102:                                 
  103:                                 
  104:                                 ;*******************************************************************
  105:                                                 ; increment a digit as ASCII and wrap from 9 to 0
  106:     2057 52                     INCASCII        INCB
  107:     2058 C1 3A                                  CMPB    #$3A
  108:     205A 26 02                                  BNE     ENDINC
  109:     205C C6 30                                  LDAB    #$30
  110:     205E 3D                     ENDINC          RTS     
  111:                                 ;*******************************************************************
  112:                                                 ; pause for ~0.1 ms
  113:     205F CE 0258                pause           ldx     #600
  114:     2062 09                     loopp           dex
  115:     2063 26 FD                                  bne     loopp
  116:     2065 3D                                     rts
  117:                                 
  118:                                 ;*******************************************************************
  119:     2066 4F 37 80 45            RTIISR          BRCLR   CRGFLG,RTIF,RTIEND
  120:     206A 86 80                                  LDAA    #RTIF
  121:     206C 5A 37                                  STAA    CRGFLG
  122:                                                 
  123:     206E                        CHKINC          ; count interrupt for incrementing the display
  124:     206E FC 1004                                LDD     RTICOUNT
  125:     2071 83 0001                                SUBD    #1
  126:     2074 7C 1004                                STD     RTICOUNT
  127:     2077 26 36                                  BNE     RTIEND
  128:     2079 1803 03D0 1004                         MOVW    #ONESEC,RTICOUNT
  129:                                                 ; increment display as a 4-digit value
  130:     207F F6 1003                                LDAB    DIGIT4
  131:     2082 16 2057                                JSR     INCASCII
  132:     2085 7B 1003                                STAB    DIGIT4
  133:     2088 C1 30                                  CMPB    #$30
  134:     208A 26 23                                  BNE     RTIEND
  135:                                 
  136:     208C F6 1002                                LDAB    DIGIT3
  137:     208F 16 2057                                JSR     INCASCII
  138:     2092 7B 1002                                STAB    DIGIT3
  139:     2095 C1 30                                  CMPB    #$30
  140:     2097 26 16                                  BNE     RTIEND
  141:                                 
  142:     2099 F6 1001                                LDAB    DIGIT2
  143:     209C 16 2057                                JSR     INCASCII
  144:     209F 7B 1001                                STAB    DIGIT2
  145:     20A2 C1 30                                  CMPB    #$30
  146:     20A4 26 09                                  BNE     RTIEND
  147:                                 
  148:     20A6 F6 1000                                LDAB    DIGIT1
  149:     20A9 16 2057                                JSR     INCASCII
  150:     20AC 7B 1000                                STAB    DIGIT1
  151:     20AF 0B                     RTIEND          RTI
  152:                                 
  153:                                 ;*******************************************************************
  154:     20B0 1F 0267 01 3C          PTHISR          BRCLR   PIFH,SW5,PTHEND
  155:     20B5 1C 0267 01                             BSET    PIFH,SW5
  156:     20B9 4E 38 80 31                            BRSET   CRGINT,RTIE,DISABLE
  157:     20BD FC 1000                                LDD     DIGIT1
  158:     20C0 8C 3030                                CPD     #$3030
  159:     20C3 26 13                                  BNE     CLEARTIME
  160:     20C5 FC 1002                                LDD     DIGIT3
  161:     20C8 8C 3030                                CPD     #$3030
  162:     20CB 26 0B                                  BNE     CLEARTIME
  163:                                                 ;start timer
  164:     20CD 1803 03D0 1004                         MOVW    #ONESEC,RTICOUNT
  165:     20D3 4C 38 80                               BSET    CRGINT,RTIE     
  166:     20D6 20 19                                  BRA     PTHEND
  167:                                                 
  168:                                                 ;clear timer
  169:     20D8 180B 30 1000           CLEARTIME       MOVB    #$30,DIGIT1
  170:     20DD 180B 30 1001                           MOVB    #$30,DIGIT2
  171:     20E2 180B 30 1002                           MOVB    #$30,DIGIT3
  172:     20E7 180B 30 1003                           MOVB    #$30,DIGIT4
  173:     20EC 20 03                                  BRA     PTHEND
  174:                                 
  175:                                                 ;stop timer
  176:     20EE 4D 38 80               DISABLE         BCLR    CRGINT,RTIE
  177:                                 
  178:     20F1 0B                     PTHEND          RTI

Symbols:
cleartime                       *000020d8
crgflg                          *00000037
crgint                          *00000038
dig1                            *00000001
dig2                            *00000002
dig3                            *00000004
dig4                            *00000008
digit                           *00002880
digit1                          *00001000
digit2                          *00001001
digit3                          *00001002
digit4                          *00001003
disable                         *000020ee
endinc                          *0000205e
incascii                        *00002057
init7seg                        *00002800
loop                            *00002029
loopp                           *00002062
onesec                          *000003d0
pause                           *0000205f
pieh                            *00000266
pifh                            *00000267
pth                             *00000260
pthend                          *000020f1
pthisr                          *000020b0
rticount                        *00001004
rtictl                          *0000003b
rtie                            *00000080
rtiend                          *000020af
rtif                            *00000080
rtiisr                          *00002066
sw5                             *00000001

